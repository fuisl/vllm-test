events {}

http {
  proxy_read_timeout  600s;
  proxy_send_timeout  600s;
  send_timeout        600s;

  proxy_buffering off;
  proxy_request_buffering off;
  proxy_http_version 1.1;

  client_max_body_size 32m;

  upstream chat  {
    server vllm-chat:8001;
    keepalive 32;
  }

  upstream embed {
    server vllm-embed:8000;
    keepalive 32;
  }

  server {
    listen 80;

    # --- CORS (browser clients). Narrow this in prod to your allowed origins.
    set $cors_origin "*";
    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    # If you need cookies, also: add_header Access-Control-Allow-Credentials "true" always;

    # Preflight fast-path
    if ($request_method = OPTIONS) { return 204; }

    # Common proxy headers
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # Avoid "Connection: keep-alive, Upgrade" surprises
    proxy_set_header Connection "";

    # --- ROUTING ---

    # Chat (OpenAI-compatible)
    location = /v1/chat/completions {
      proxy_read_timeout  600s;
      proxy_send_timeout  600s;
      proxy_pass http://chat;
    }

    # Legacy completions (some SDKs still call this)
    location = /v1/completions {
      proxy_read_timeout  600s;
      proxy_send_timeout  600s;
      proxy_pass http://chat;
    }

    # Embeddings
    location = /v1/embeddings {
      proxy_read_timeout  600s;
      proxy_send_timeout  600s;
      proxy_pass http://embed;
    }

    # Handy health check that hits the model server (returns JSON)
    location = /v1/models {
      proxy_pass http://chat;
    }

    # Simple health check for the proxy itself
    location = /v1/health { return 200 "ok\n"; }

    # Default: forbid anything else so misroutes are obvious
    location / { return 404; }
  }
}
